<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OSA Phenotyper (Prototype v7)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{padding-top:20px;}
.section{margin-bottom:40px;}
summary{cursor:pointer;}
fieldset{border:1px solid #ced4da;padding:10px 12px;border-radius:6px;margin-bottom:15px;}
legend{padding:0 6px;font-size:1rem;font-weight:600;width:auto;}
</style>
</head>
<body>
<div class="container">
<h1 class="mb-3">OSA Phenotyping Tool <small class="text-muted">(v7)</small></h1>

<!-- Sleep study selector -->
<div class="section">
<label class="form-label fw-bold me-2">Sleep Study Type:</label>
<select class="form-select d-inline-block w-auto" id="studyType" onchange="toggleStudySections()">
  <option value="PSG">Lab PSG (Level I)</option>
  <option value="WatchPAT">Home Sleep Test – WatchPAT</option>
</select>
</div>

<form id="osaForm">
<!-- Demographics -->
<div class="section">
<h4>Demographics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">Age</label><input type="number" class="form-control" id="age"></div>
  <div class="col-md-2"><label class="form-label">Sex</label><select class="form-select" id="sex"><option>Male</option><option>Female</option></select></div>
  <div class="col-md-2"><label class="form-label">BMI</label><input type="number" step="0.1" class="form-control" id="bmi"></div>
  <div class="col-md-2"><label class="form-label">Neck Circ. (in)</label><input type="number" step="0.1" class="form-control" id="neck"></div>
</div>
</div>

<!-- Physical exam -->
<div class="section">
<h4>Physical Exam</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">Deviated Septum</label><select class="form-select" id="septum"><option value="">None</option><option>Yes</option></select></div>
  <div class="col-md-2"><label class="form-label">Turbinates</label><select class="form-select" id="turbinates"><option>None</option><option>Mild</option><option>Moderate</option><option>Severe</option></select></div>
  <div class="col-md-2"><label class="form-label">Rhinitis</label><select class="form-select" id="rhinitis"><option>None</option><option>Mild</option><option>Moderate</option><option>Severe</option></select></div>
  <div class="col-md-2"><label class="form-label">Tonsil Size</label><select class="form-select" id="tonsils"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
  <div class="col-md-2"><label class="form-label">FTP</label><select class="form-select" id="ftp"><option>I</option><option>II</option><option>III</option><option>IV</option></select></div>
</div>
</div>

<!-- Imaging & endoscopy -->
<div class="section">
<h4>Imaging &amp; Endoscopy</h4>

<fieldset>
<legend>CT Sinus (select all that apply)</legend>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="checkbox" id="ctDeviated">
  <label class="form-check-label" for="ctDeviated">Deviated Septum</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="checkbox" id="ctTurbs">
  <label class="form-check-label" for="ctTurbs">Turbinates Hypertrophy</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="checkbox" id="ctSinusitis">
  <label class="form-check-label" for="ctSinusitis">Sinusitis</label>
</div>
</fieldset>

<fieldset>
<legend>DISE – VOTE Classification</legend>
<div class="table-responsive">
<table class="table table-sm align-middle">
<thead><tr><th>Site</th><th>Degree (0/1/2)</th><th>Pattern</th></tr></thead>
<tbody>
<tr><td>Velum</td>
<td><select class="form-select form-select-sm" id="vDeg"><option>0</option><option>1</option><option>2</option></select></td>
<td><select class="form-select form-select-sm" id="vPat"><option value="">—</option><option>AP</option><option>Lateral</option><option>Concentric</option></select></td></tr>

<tr><td>Oropharynx</td>
<td><select class="form-select form-select-sm" id="oDeg"><option>0</option><option>1</option><option>2</option></select></td>
<td><select class="form-select form-select-sm" id="oPat"><option value="">—</option><option>Lateral</option></select></td></tr>

<tr><td>Tongue Base</td>
<td><select class="form-select form-select-sm" id="tDeg"><option>0</option><option>1</option><option>2</option></select></td>
<td><select class="form-select form-select-sm" id="tPat"><option value="">—</option><option>AP</option></select></td></tr>

<tr><td>Epiglottis</td>
<td><select class="form-select form-select-sm" id="eDeg"><option>0</option><option>1</option><option>2</option></select></td>
<td><select class="form-select form-select-sm" id="ePat"><option value="">—</option><option>AP</option><option>Lateral</option></select></td></tr>
</tbody></table>
</div>
</fieldset>
</div>

<!-- Questionnaires -->
<div class="section">
<h4>Questionnaires</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">ESS</label><input type="number" class="form-control" id="ess"></div>
  <div class="col-md-2"><label class="form-label">ISI</label><input type="number" class="form-control" id="isi"></div>
</div>
</div>

<div class="section">
<p class="text-muted">Sleep‑study fields unchanged (see previous version).</p>
</div>

<button type="button" class="btn btn-primary" onclick="runAnalysis()">Run Analysis</button>
</form>

<hr>
<div id="patientSummary" class="mt-4"></div>
<div id="clinicianReport" class="mt-4"></div>
</div>

<script>
// Simple obtain helpers
function num(id){return parseFloat(document.getElementById(id)?.value)||0;}
function val(id){return document.getElementById(id)?.value||'';}
function checked(id){return document.getElementById(id).checked;}

// placeholder for study toggle
function toggleStudySections(){}

function runAnalysis(){
  const phen=[], why={};const add=(p,r)=>{phen.push(p);why[p]=(why[p]||[]).concat(r);};

  // High anatomical reinforcement
  if(['3','4'].includes(val('tonsils'))) add('High Anatomical Contribution',['Tonsils '+val('tonsils')]);
  if(['III','IV'].includes(val('ftp'))) add('High Anatomical Contribution',['FTP '+val('ftp')]);
  if(val('septum')==='Yes' || checked('ctDeviated')) add('High Anatomical Contribution',['Septal deviation']);
  if(['Moderate','Severe'].includes(val('turbinates')) || checked('ctTurbs')) add('High Anatomical Contribution',['Turbinate hypertrophy']);
  if(['Moderate','Severe'].includes(val('rhinitis'))) add('High Anatomical Contribution',['Moderate/severe rhinitis']);
  // CT sinusitis could hint inflammation – not necessarily anatomical collapse; optional

  // DISE: if any site degree 2, mark anatomical
  const diseDeg=[num('vDeg'),num('oDeg'),num('tDeg'),num('eDeg')];
  if(diseDeg.some(d=>d===2)) add('High Anatomical Contribution',['DISE degree 2 at one or more sites']);

  // Build patient-friendly output (demo)
  const patHTML='<h3>Patient Summary</h3><p>Phenotypes: '+(phen.join(', ')||'None flagged')+'</p>';
  const clin='<h3>Clinician Report</h3><ul>'+phen.map(p=>'<li><strong>'+p+':</strong> '+why[p].join(', ')+'</li>').join('')+'</ul>';
  document.getElementById('patientSummary').innerHTML=patHTML;
  document.getElementById('clinicianReport').innerHTML=clin;
}
</script>
</body>
</html>
