<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OSA Phenotyper (Prototype v5)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{padding-top:20px;}
.section{margin-bottom:40px;}
summary{cursor:pointer;}
</style>
</head>
<body>
<div class="container">
<h1 class="mb-3">OSA Phenotyping &amp; Recommendation Tool <small class="text-muted">(v5)</small></h1>

<!-- Study type -->
<div class="section">
<label class="form-label fw-bold me-2">Sleep Study Type:</label>
<select class="form-select d-inline-block w-auto" id="studyType" onchange="toggleStudySections()">
  <option value="PSG">Lab PSG (Level I)</option>
  <option value="WatchPAT">Home Sleep Test – WatchPAT</option>
</select>
</div>

<form id="osaForm">
<!-- Demographics -->
<div class="section">
<h4>Demographics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">Age</label><input type="number" class="form-control" id="age"></div>
  <div class="col-md-2"><label class="form-label">Sex</label><select class="form-select" id="sex"><option>Male</option><option>Female</option></select></div>
  <div class="col-md-2"><label class="form-label">BMI</label><input type="number" step="0.1" class="form-control" id="bmi"></div>
  <div class="col-md-2"><label class="form-label">Neck Circ. (in)</label><input type="number" step="0.1" class="form-control" id="neck"></div>
</div>
</div>

<!-- Questionnaires -->
<div class="section">
<h4>Questionnaires</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">ESS</label><input type="number" class="form-control" id="ess"></div>
  <div class="col-md-2"><label class="form-label">ISI</label><input type="number" class="form-control" id="isi"></div>
</div>
</div>

<!-- PSG block -->
<div class="section study-block" data-study="PSG">
<h4>Lab PSG Metrics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">AHI (overall)</label><input type="number" step="0.1" class="form-control" id="ahi"></div>
  <div class="col-md-2"><label class="form-label">AHI Supine</label><input type="number" step="0.1" class="form-control" id="ahiSupine"></div>
  <div class="col-md-2"><label class="form-label">AHI Non‑Supine</label><input type="number" step="0.1" class="form-control" id="ahiNonSupine"></div>
  <div class="col-md-2"><label class="form-label">AHI REM</label><input type="number" step="0.1" class="form-control" id="ahiREM"></div>
  <div class="col-md-2"><label class="form-label">AHI NREM</label><input type="number" step="0.1" class="form-control" id="ahiNREM"></div>
  <div class="col-md-2"><label class="form-label">CAI</label><input type="number" step="0.1" class="form-control" id="cai"></div>
  <div class="col-md-2"><label class="form-label">Arousal Index</label><input type="number" step="0.1" class="form-control" id="arousalIdx"></div>
  <div class="col-md-2"><label class="form-label">Nadir SpO₂ (%)</label><input type="number" step="0.1" class="form-control" id="nadir"></div>
</div>
</div>

<!-- WatchPAT block -->
<div class="section study-block" data-study="WatchPAT" style="display:none;">
<h4>WatchPAT Metrics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">pAHI (overall)</label><input type="number" step="0.1" class="form-control" id="pahi"></div>
  <div class="col-md-2"><label class="form-label">Supine pAHI</label><input type="number" step="0.1" class="form-control" id="pahiSupine"></div>
  <div class="col-md-2"><label class="form-label">pAHI REM</label><input type="number" step="0.1" class="form-control" id="pahiREM"></div>
  <div class="col-md-2"><label class="form-label">pAHI NREM</label><input type="number" step="0.1" class="form-control" id="pahiNREM"></div>
  <div class="col-md-2"><label class="form-label">PAT RDI</label><input type="number" step="0.1" class="form-control" id="rdi"></div>
  <div class="col-md-2"><label class="form-label">ODI 4%</label><input type="number" step="0.1" class="form-control" id="odi"></div>
  <div class="col-md-2"><label class="form-label">Min SpO₂ (%)</label><input type="number" step="0.1" class="form-control" id="nadirWatch"></div>
  <div class="col-md-2"><label class="form-label">TST (hrs)</label><input type="number" step="0.1" class="form-control" id="tst"></div>
</div>
</div>

<button type="button" class="btn btn-primary" onclick="runAnalysis()">Run Analysis</button>
</form>

<hr>
<div id="patientSummary" class="mt-4"></div>
<div id="clinicianReport" class="mt-4"></div>
</div>

<script>
function num(id){return parseFloat(document.getElementById(id)?.value)||0;}
function list(arr){return arr.map(x=>'<li>'+x+'</li>').join('');}
function toggleStudySections(){const v=document.getElementById('studyType').value;document.querySelectorAll('.study-block').forEach(d=>d.style.display=d.getAttribute('data-study')===v?'block':'none');}

function runAnalysis(){
 const study=document.getElementById('studyType').value;
 const sex=document.getElementById('sex').value;
 const bmi=num('bmi'), neck=num('neck'), ess=num('ess'), isi=num('isi');
 let ahi=0, supine=0, nonsup=0, rem=0, nrem=0, cai=0, arousal=0, nadir=0;

 if(study==='PSG'){
   ahi=num('ahi'); supine=num('ahiSupine'); nonsup=num('ahiNonSupine'); rem=num('ahiREM'); nrem=num('ahiNREM');
   cai=num('cai'); arousal=num('arousalIdx'); nadir=num('nadir');
 } else {
   ahi=num('pahi'); supine=num('pahiSupine'); rem=num('pahiREM'); nrem=num('pahiNREM');
   nadir=num('nadirWatch');
 }

 const phen=[], why={};
 const add=(p,r)=>{phen.push(p);why[p]=(why[p]||[]).concat(r);};

 if((sex==='Male'&&neck>=17)||(sex==='Female'&&neck>=16)||bmi>=30||ahi>=30)add('High Anatomical Contribution',[`Neck ${neck||'?'}`,`BMI ${bmi||'?'}`,`Index ${ahi}`]);
 if(study==='PSG' && ((arousal/Math.max(ahi,1)>0.5)||isi>=15)) add('Low Arousal Threshold',[`Arousal ${arousal}`,`ISI ${isi}`]);
 if(supine && supine>0 && ((study==='PSG' && supine>2*nonsup && nonsup<15) || (study==='WatchPAT' && supine>2*ahi && ahi<20))) add('Positional OSA',[`Supine index ${supine}`,`Overall index ${ahi}`]);
 if(rem && rem>0 && rem>2*Math.max(nrem,1) && rem>=10) add('REM‑Predominant OSA',[`REM index ${rem}`,`NREM ${nrem}`]);
 if(cai>=5) add('High Loop Gain / Complex Sleep Apnea risk',[`CAI ${cai}`]);
 if(nadir && nadir<85) add('High Hypoxic Burden',[`Min SpO₂ ${nadir}%`]);

 const recLib={'High Anatomical Contribution':'CPAP/APAP first‑line; weight optimisation; consider MAD, surgery or Inspire™ if needed.',
 'Low Arousal Threshold':'Improve CPAP comfort; CBT‑I; judicious low‑dose sedative under specialist.',
 'Positional OSA':'Positional therapy (side‑sleeping device) or oral appliance.',
 'REM‑Predominant OSA':'Ensure adequate CPAP in REM (auto‑titrating) or MAD.',
 'High Loop Gain / Complex Sleep Apnea risk':'Fixed‑pressure CPAP or ASV (no HFrEF); oxygen supplementation.',
 'High Hypoxic Burden':'Prioritise effective therapy to improve oxygen saturation and CV risk.'};

 const recs=[]; phen.forEach(p=>{if(recLib[p])recs.push(recLib[p]);});
 if(!recs.length) recs.push('Standard CPAP/APAP remains the first‑line therapy for most OSA patients.');

 const explanations={'High Anatomical Contribution':'Your airway is physically narrow ...',
 'Low Arousal Threshold':'You wake easily ...',
 'Positional OSA':'Events mainly happen on your back ...',
 'REM‑Predominant OSA':'Events mainly in dreaming sleep ...',
 'High Loop Gain / Complex Sleep Apnea risk':'Breathing control is unstable ...',
 'High Hypoxic Burden':'Oxygen drops quite low ...'};

 // patient summary
 let pat='<h3>Patient‑Friendly Summary</h3>';
 if(phen.length){pat+='<p>Your results suggest these contributing factors:</p>';phen.forEach(p=>{pat+=`<details><summary><strong>${p}</strong></summary><div class="mt-2">${explanations[p]||''}</div></details>`;});}
 else pat+='<p>No clear patterns flagged from the data entered.</p>';
 pat+='<h5 class="mt-4">Top Treatment Options</h5><ul>'+list(recs)+'</ul><p class="mt-3">Discuss these options with your clinician.</p>';

 // clinician report
 let cli='<h3>Clinician Decision Support</h3><p><strong>Study type:</strong> '+study+'</p>';
 if(phen.length){cli+='<ul>';phen.forEach(p=>{cli+='<li><strong>'+p+'</strong> — '+why[p].join(', ')+'</li>';});cli+='</ul>';}else{cli+='<p>No phenotype triggered.</p>';}
 cli+='<p><strong>Recommendations:</strong></p><ol>'+list(recs)+'</ol><p><em>Prototype rules—verify clinically.</em></p>';

 document.getElementById('patientSummary').innerHTML=pat;
 document.getElementById('clinicianReport').innerHTML=cli;
}

toggleStudySections();
</script>
</body>
</html>
