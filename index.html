<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OSA Phenotyper (Prototype v8)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{padding-top:20px;}
.section{margin-bottom:40px;}
summary{cursor:pointer;}
fieldset{border:1px solid #ced4da;padding:10px 12px;border-radius:6px;margin-bottom:15px;}
legend{padding:0 6px;font-size:1rem;font-weight:600;width:auto;}
.card-phen{border-left:6px solid #0d6efd;padding-left:8px;margin-bottom:8px;}
</style>
</head>
<body>
<div class="container">
<h1 class="mb-3">OSA Phenotyping Tool <small class="text-muted">(v8)</small></h1>

<!-- Sleep study selector -->
<div class="section">
<label class="form-label fw-bold me-2">Sleep Study Type:</label>
<select class="form-select d-inline-block w-auto" id="studyType" onchange="toggleStudySections()">
  <option value="PSG">Lab PSG (Level I)</option>
  <option value="WatchPAT">Home Sleep Test – WatchPAT</option>
</select>
</div>

<form id="osaForm">
<!-- Demographics -->
<div class="section">
<h4>Demographics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">Age</label><input type="number" class="form-control" id="age"></div>
  <div class="col-md-2"><label class="form-label">Sex</label><select class="form-select" id="sex"><option>Male</option><option>Female</option></select></div>
  <div class="col-md-2"><label class="form-label">BMI</label><input type="number" step="0.1" class="form-control" id="bmi"></div>
  <div class="col-md-2"><label class="form-label">Neck Circ. (in)</label><input type="number" step="0.1" class="form-control" id="neck"></div>
</div>
</div>

<!-- Medical History -->
<div class="section">
<h4>Medical History</h4>
<div class="row g-3">
  <div class="col-md-3">
    <label class="form-label">Cardiovascular Disease<br><span class="small text-muted">(HTN, CAD, HF, AF, etc.)</span></label>
    <select class="form-select" id="cvd"><option>No</option><option>Yes</option></select>
  </div>
</div>
</div>

<!-- Physical exam (kept as in v7, trimmed for brevity) -->
<div class="section">
<h4>Physical Exam</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">Deviated Septum</label><select class="form-select" id="septum"><option value="">None</option><option>Yes</option></select></div>
  <div class="col-md-2"><label class="form-label">Turbinates</label><select class="form-select" id="turbinates"><option>None</option><option>Mild</option><option>Moderate</option><option>Severe</option></select></div>
  <div class="col-md-2"><label class="form-label">Rhinitis</label><select class="form-select" id="rhinitis"><option>None</option><option>Mild</option><option>Moderate</option><option>Severe</option></select></div>
  <div class="col-md-2"><label class="form-label">Tonsil Size</label><select class="form-select" id="tonsils"><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
  <div class="col-md-2"><label class="form-label">FTP</label><select class="form-select" id="ftp"><option>I</option><option>II</option><option>III</option><option>IV</option></select></div>
</div>
</div>

<!-- Imaging & DISE unchanged from v7 -->
<div class="section">
<h4>Imaging &amp; Endoscopy</h4>
<fieldset>
<legend>CT Sinus (select all that apply)</legend>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="checkbox" id="ctDeviated">
  <label class="form-check-label" for="ctDeviated">Deviated Septum</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="checkbox" id="ctTurbs">
  <label class="form-check-label" for="ctTurbs">Turbinates Hypertrophy</label>
</div>
<div class="form-check form-check-inline">
  <input class="form-check-input" type="checkbox" id="ctSinusitis">
  <label class="form-check-label" for="ctSinusitis">Sinusitis</label>
</div>
</fieldset>
<!-- DISE VOTE table omitted for brevity -->
</div>

<!-- Questionnaires -->
<div class="section">
<h4>Questionnaires</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">ESS</label><input type="number" class="form-control" id="ess"></div>
  <div class="col-md-2"><label class="form-label">ISI</label><input type="number" class="form-control" id="isi"></div>
</div>
</div>

<!-- PSG and WatchPAT blocks -->
<div class="section study-block" data-study="PSG">
<h4>Lab PSG Metrics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">AHI</label><input type="number" step="0.1" class="form-control" id="ahi"></div>
  <div class="col-md-2"><label class="form-label">ODI 4%</label><input type="number" step="0.1" class="form-control" id="odiPSG"></div>
  <div class="col-md-2"><label class="form-label">Nadir SpO₂ (%)</label><input type="number" step="0.1" class="form-control" id="nadir"></div>
</div>
</div>

<div class="section study-block" data-study="WatchPAT" style="display:none;">
<h4>WatchPAT Metrics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">pAHI</label><input type="number" step="0.1" class="form-control" id="pahi"></div>
  <div class="col-md-2"><label class="form-label">ODI 4%</label><input type="number" step="0.1" class="form-control" id="odi"></div>
  <div class="col-md-2"><label class="form-label">Min SpO₂ (%)</label><input type="number" step="0.1" class="form-control" id="nadirWatch"></div>
  <div class="col-md-2"><label class="form-label">Snoring Index<br><span class="small text-muted">(events/hr)</span></label><input type="number" step="0.1" class="form-control" id="snoreIdx"></div>
</div>
</div>

<button type="button" class="btn btn-primary" onclick="runAnalysis()">Run Analysis</button>
</form>

<hr>
<div id="patientSummary" class="mt-4"></div>
<div id="clinicianReport" class="mt-4"></div>
</div>

<script>
function num(id){return parseFloat(document.getElementById(id)?.value)||0;}
function val(id){return document.getElementById(id)?.value||'';}
function checked(id){return document.getElementById(id).checked;}

function toggleStudySections(){
  const st=val('studyType');
  document.querySelectorAll('.study-block').forEach(d=>d.style.display=d.getAttribute('data-study')===st?'block':'none');
}

function list(arr){return arr.map(x=>'<li>'+x+'</li>').join('');}

function runAnalysis(){
  const study=val('studyType');
  const ess=num('ess'), isi=num('isi');
  // gather oximetry
  const nadir = study==='PSG'? num('nadir') : num('nadirWatch');
  const odi = study==='PSG'? num('odiPSG') : num('odi');

  const phen=[], why={}; const add=(p,r)=>{phen.push(p);why[p]=(why[p]||[]).concat(r);};

  // Existing anatomical flags omitted here but assume present...
  if(nadir && nadir<85) add('High Hypoxic Burden',[`Minimum SpO₂ ${nadir}%`]);
  if(odi && odi>=40) add('High Hypoxic Burden',[`ODI 4% ${odi}`]);

  // Symptom subtype
  let subtype='';
  if(ess>=15) subtype='Sleepy';
  else if(isi>=15) subtype='Disturbed‑sleep';
  else subtype='Minimally Symptomatic';

  // Recommendations
  const recs=[];
  if(phen.includes('High Hypoxic Burden')){
      recs.push('Prioritise effective therapy (usually CPAP) to lower oxygen‑drop burden and cut cardiovascular risk.');
      if(val('cvd')==='Yes') recs.push('Aggressively manage cardiovascular risk factors in parallel (BP, lipids, weight).');
  }
  if(!recs.length) recs.push('Standard CPAP/APAP remains first‑line treatment.');

  /* ---------- Patient Summary ---------- */
  let pat='<h3>Patient‑Friendly Summary</h3>';
  pat+=`<p>You fall into the <strong>${subtype}</strong> symptom group. `;
  if(subtype==='Sleepy') pat+='Treating sleep‑apnea typically improves daytime alertness and driving safety.';
  else if(subtype==='Disturbed‑sleep') pat+='Combining airway treatment with cognitive‑behavioural therapy for insomnia often works best.';
  pat+='</p>';

  if(phen.length){
     pat+='<h5>Contributing factors detected:</h5>';
     phen.forEach(p=>{
        let expl='';
        if(p==='High Hypoxic Burden') expl='Your oxygen level spends a lot of time low at night, which can strain the heart and blood vessels.';
        pat+=`<div class="card-phen"><strong>${p}</strong><br><span class="small">${expl}</span></div>`;
     });
  }

  pat+='<h5 class="mt-3">Recommended next steps</h5><ul>'+list(recs)+'</ul>';

  /* ---------- Clinician Report ---------- */
  let cli='<h3>Clinician Decision Support</h3>';
  cli+=`<p><strong>Symptom subtype:</strong> ${subtype} (ESS ${ess}, ISI ${isi})</p>`;
  if(phen.length){
     cli+='<p><strong>Phenotype triggers:</strong></p><ul>';
     phen.forEach(p=>{cli+=`<li>${p} – ${why[p].join(', ')}</li>`;});
     cli+='</ul>';
  } else cli+='<p>No phenotype triggered based on current inputs.</p>';

  cli+='<p><strong>Plan considerations:</strong></p><ol>'+list(recs)+'</ol>';

  document.getElementById('patientSummary').innerHTML=pat;
  document.getElementById('clinicianReport').innerHTML=cli;
}

toggleStudySections();
</script>
</body>
</html>
