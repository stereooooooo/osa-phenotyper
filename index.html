<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OSA Phenotyper (Prototype v6)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{padding-top:20px;}
.section{margin-bottom:40px;}
summary{cursor:pointer;}
fieldset{border:1px solid #ccc;padding:10px;margin-bottom:15px;border-radius:6px;}
legend{width:auto;padding:0 5px;font-size:1rem;font-weight:600;}
</style>
</head>
<body>
<div class="container">
<h1 class="mb-3">OSA Phenotyping Tool <small class="text-muted">(v6)</small></h1>

<!-- Study type -->
<div class="section">
<label class="form-label fw-bold me-2">Sleep Study Type:</label>
<select class="form-select d-inline-block w-auto" id="studyType" onchange="toggleStudySections()">
  <option value="PSG">Lab PSG (Level I)</option>
  <option value="WatchPAT">Home Sleep Test – WatchPAT</option>
</select>
</div>

<form id="osaForm">
<!-- Demographics -->
<div class="section">
<h4>Demographics</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">Age</label><input type="number" class="form-control" id="age"></div>
  <div class="col-md-2"><label class="form-label">Sex</label><select class="form-select" id="sex"><option>Male</option><option>Female</option></select></div>
  <div class="col-md-2"><label class="form-label">BMI</label><input type="number" step="0.1" class="form-control" id="bmi"></div>
  <div class="col-md-2"><label class="form-label">Neck Circ. (in)</label><input type="number" step="0.1" class="form-control" id="neck"></div>
</div>
</div>

<!-- Physical exam -->
<div class="section">
<h4>Physical Exam</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">Deviated Septum</label><select class="form-select" id="septum"><option value="">No</option><option>Yes</option></select></div>
  <div class="col-md-2"><label class="form-label">Turbinates Hypertrophy</label><select class="form-select" id="turbinates"><option value="">No</option><option>Mild</option><option>Moderate</option><option>Severe</option></select></div>
  <div class="col-md-2"><label class="form-label">Rhinitis</label><select class="form-select" id="rhinitis"><option value="">No</option><option>Allergic</option><option>Non‑allergic</option></select></div>
  <div class="col-md-2"><label class="form-label">Tonsil Size</label><select class="form-select" id="tonsils"><option value="">0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
  <div class="col-md-2"><label class="form-label">Friedman Tongue Position</label><select class="form-select" id="ftp"><option value="">I</option><option>II</option><option>III</option><option>IV</option></select></div>
</div>
</div>

<!-- Imaging -->
<div class="section">
<h4>Imaging &amp; Endoscopy</h4>
<fieldset>
<legend>CT of Sinuses</legend>
<div class="row g-3">
  <div class="col-md-3"><label class="form-label">Performed?</label><select class="form-select" id="ctDone" onchange="toggleCT()"><option value="">No</option><option>Yes</option></select></div>
  <div class="col-md-3 ct-field d-none"><label class="form-label">CT Findings</label><select class="form-select" id="ctFindings"><option>Normal</option><option>Deviated Septum</option><option>Turbinates Hypertrophy</option><option>Sinusitis</option></select></div>
</div>
</fieldset>

<fieldset>
<legend>Drug‑Induced Sleep Endoscopy (DISE)</legend>
<div class="row g-3">
  <div class="col-md-3"><label class="form-label">Performed?</label><select class="form-select" id="diseDone" onchange="toggleDISE()"><option value="">No</option><option>Yes</option></select></div>
</div>
<div class="row g-3 dise-field d-none">
  <div class="col-md-3"><label class="form-label">Velum</label><select class="form-select" id="diseV"><option value="">0</option><option>I</option><option>II</option><option>III</option></select></div>
  <div class="col-md-3"><label class="form-label">Oropharynx</label><select class="form-select" id="diseO"><option value="">0</option><option>I</option><option>II</option><option>III</option></select></div>
  <div class="col-md-3"><label class="form-label">Tongue Base</label><select class="form-select" id="diseT"><option value="">0</option><option>I</option><option>II</option><option>III</option></select></div>
  <div class="col-md-3"><label class="form-label">Epiglottis</label><select class="form-select" id="diseE"><option value="">0</option><option>I</option><option>II</option><option>III</option></select></div>
</div>
</fieldset>
</div>

<!-- Questionnaires -->
<div class="section">
<h4>Questionnaires</h4>
<div class="row g-3">
  <div class="col-md-2"><label class="form-label">ESS</label><input type="number" class="form-control" id="ess"></div>
  <div class="col-md-2"><label class="form-label">ISI</label><input type="number" class="form-control" id="isi"></div>
</div>
</div>

<!-- PSG and WatchPAT blocks here (omitted for brevity) -->
<p class="text-muted">Sleep study inputs unchanged from v5 (AHI, pAHI etc.).</p>

<button type="button" class="btn btn-primary" onclick="runAnalysis()">Run Analysis</button>
</form>

<hr>
<div id="patientSummary" class="mt-4"></div>
<div id="clinicianReport" class="mt-4"></div>
</div>

<script>
function num(id){return parseFloat(document.getElementById(id)?.value)||0;}
function val(id){return document.getElementById(id)?.value||'';}

function toggleStudySections(){/* same as before */}

// Toggle CT / DISE visibility
function toggleCT(){document.querySelectorAll('.ct-field').forEach(el=>el.classList.toggle('d-none',val('ctDone')!=='Yes'));}
function toggleDISE(){document.querySelectorAll('.dise-field').forEach(el=>el.classList.toggle('d-none',val('diseDone')!=='Yes'));}

function runAnalysis(){
  // simplified: use tonsil size ≥3, FTP III‑IV, septal deviation yes, turbinate moderate‑severe OR CT corroboration to reinforce anatomical phenotype
  const phen=[], why={};const add=(p,r)=>{phen.push(p);why[p]=(why[p]||[]).concat(r);};
  // Example: high anatomy if big tonsils or FTP high
  if(['3','4'].includes(val('tonsils')) || ['III','IV'].includes(val('ftp')) || val('septum')==='Yes' || ['Moderate','Severe'].includes(val('turbinates')) || val('ctFindings')==='Deviated Septum'){
     add('High Anatomical Contribution',['PE/CT findings']);
  }
  // for brevity other rules from v5 would be merged here...
  const patientHTML="<p>(demo) Added physical‑exam logic placeholder.</p>";
  document.getElementById('patientSummary').innerHTML=patientHTML;
  document.getElementById('clinicianReport').innerHTML="<p>(demo) Clinician report will show reasons.</p>";
}
toggleCT();toggleDISE();
</script>
</body>
</html>
